<?xml version="1.0" encoding="utf-8"?>
<modification>
    <name>{name}</name>
    <version>{version}</version>
    <author>HuntBee OpenCart Services</author>
    <link>http://www.huntbee.com</link>
	<code>huntbee_seo_multi_language_url_ocmod</code>

	<file path="catalog/controller/startup/seo_url.php">
		<operation>
			<search><![CDATA[public function rewrite($link) {]]></search>
			<add position="before"><![CDATA[
			private function forceSetLanguage($language_id = '1') {
				$this->session->data['language_id'] = $language_id;
				if (isset($this->session->data['language_id'])){
					$this->config->set('config_language_id',$this->session->data['language_id']);
					
					$language_code = $this->db->query("SELECT `code` FROM `".DB_PREFIX."language` WHERE language_id = '".(int)$this->session->data['language_id']."'");
					$this->session->data['language'] = $language_code->row['code'];
					$this->language = new Language($this->session->data['language']);
					$this->language->load($this->session->data['language']);
					$this->registry->set('language', $this->language);
				}
			}		
			]]></add>
		</operation>
		<operation>
			<search><![CDATA[if ($query->row['query'] && $url[0] != 'information_id' && $url[0] != 'manufacturer_id' && $url[0] != 'category_id' && $url[0] != 'product_id') {]]></search>
			<add position="replace"><![CDATA[
				if ($url[0] == 'language_id') {
					$this->request->get['language_id'] = $url[1];
				}

				$this->forceSetLanguage($query->row['language_id']);		
			
				if ($query->row['query'] && $url[0] != 'information_id' && $url[0] != 'manufacturer_id' && $url[0] != 'category_id' && $url[0] != 'product_id' && $url[0] != 'language_id') {
				]]></add>
		</operation>
		<operation>
			<search><![CDATA[if (!isset($this->request->get['route'])) {]]></search>
			<add position="before"><![CDATA[
			$hb_lang_route = $this->db->query("SELECT `language_id` FROM `".DB_PREFIX."language` WHERE `code` LIKE '".$this->db->escape($this->request->get['_route_'])."%' LIMIT 1");
			if ($hb_lang_route->num_rows == 1) {
				$this->request->get['route'] = 'common/home';
				$this->forceSetLanguage($hb_lang_route->row['language_id']);
			}	
			]]></add>
		</operation>
		<operation>
			<search><![CDATA[parse_str($url_info['query'], $data);]]></search>
			<add position="before"><![CDATA[
			$default_language_code = $this->config->get('config_language');

			if (isset($this->session->data['language'])){
				$language_code = $this->session->data['language'];
			}else{
				$language_code = $default_language_code;
			}
			
			if ($language_code == $default_language_code) {
				$set_language_code = '';
			}else{
				$set_language_code = substr($language_code,0,2);
			}
			]]></add>
		</operation>
		<operation>
			<search><![CDATA[unset($data['route']);]]></search>
			<add position="after"><![CDATA[
			unset($data['language_id']);
			]]></add>
		</operation>
	</file>
	
	<file path="catalog/controller/common/language.php">
		<operation>
			<search><![CDATA[$this->session->data['language'] = $this->request->post['code'];]]></search>
			<add position="after"><![CDATA[
			$language_query = $this->db->query("SELECT `language_id` FROM ".DB_PREFIX."language WHERE `code` = '".$this->session->data['language']."'");
			$this->session->data['language_id'] = $language_query->row['language_id'];
			$this->config->set('config_language_id', $language_query->row['language_id']);
			]]></add>
		</operation>
		<operation>
			<search><![CDATA[$url_data = $this->request->get;]]></search>
			<add position="after"><![CDATA[
			$additional_url_data = $url_data;
			$this->session->data['additional_url_data'] = $additional_url_data;
			]]></add>
		</operation>
		<operation>
			<search><![CDATA[$this->response->redirect($this->request->post['redirect']);]]></search>
			<add position="replace"><![CDATA[
			$url = $this->url->link('common/home');
			if (isset($this->session->data['additional_url_data'])){
				$url_data = $this->session->data['additional_url_data'];
				unset($url_data['_route_']);
				$route = $url_data['route'];
				unset($url_data['route']); 
				$url = $this->url->link($route, http_build_query($url_data), true);
			}
			
			$this->response->redirect($url);
			]]></add>
		</operation>
	</file>

	<!--hreflang - https://support.google.com/webmasters/answer/189077?hl=en-->	
	<file path="catalog/controller/common/header.php">
	<operation>
		<search><![CDATA[$data['base'] = $server;]]></search>
		<add position="before"><![CDATA[
			$url_parameters = $this->request->get;	
			$data['hreflang'] = [];
			$this->load->model('extension/module/hb_seourl');

			if (isset($this->request->get['route'])) {
				$route = $this->request->get['route'];
				$data['hreflang'] = $this->model_extension_module_hb_seourl->hreflang($route, $url_parameters);
			}else{
				$data['hreflang'] = $this->model_extension_module_hb_seourl->hreflang_home();
			}
		
		]]></add>
	</operation>			
	</file>
	<file path="catalog/view/theme/*/template/common/header.twig">
	<operation>
		<search><![CDATA[<base href="{{ base }}" />]]></search>
		<add position="after"><![CDATA[
{% if hreflang %}
{% for alternate in hreflang %}
{{ alternate }}
{% endfor %}
{% endif %}
]]></add>
	</operation>			
	</file>
</modification>